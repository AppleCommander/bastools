commands:
  bt:
    main-class: org.applecommander.bastools.tools.bt.Main
    system-exit: yes
    executable:  tools/bt/build/native/nativeCompile/bt-*

files:
  helloWorldUC:
    type: text
    content: |
      10 TEXT
      20 HOME
      30 PRINT "HELLO, WORLD"
      40 END
    suffix: .bas
  helloWorldLC:
    type: text
    content: |
      10 text
      20 home
      30 print "Hello, World"
      40 end
    suffix: .bas
  numberPreservation:    # See https://github.com/AppleCommander/bastools/issues/49
    type: text
    content: |
      10 PRINT "MATHING"
      30 A = .4
      40 B = 0.6000
      50 C = -.250
      60 D = -0.70
      70 PRINT "A=";A
      80 PRINT "B=";B
      90 PRINT "C=";C
      95 PRINT "D=";D
    suffix: .bas
  checkitSample:
    type: text
    content: |
      10 REM RING THE BELL
      20 FOR J = 1 TO 5:PRINT CHR$ (7):NEXT J
      30 END
    suffix: .bas
  # From Compute! July 1985 issue - this code is just above the introductory article for the Apple Automatic Proofreader
  proofreaderSample:
    type: text
    content: |
      10 HOME
      20 D$ = CHR$(4)
      40 PRINT "DO YOU WANT TO:"
      50 PRINT " (1) MAKE A SPEEDSCRIPT FILE INTO A TEXT FILE"
      60 PRINT " (2) MAKE A TEXT FILE INTO A SPEEDSCRIPT FILE"
      70 GET A$:A = VAL(A$)
      80 IF A<>1 AND A<>2 THEN 70
      90 ON A GOTO 100,200
    suffix: .bas
  # Just a silly example as a start
  appleCheckerSample:
    type: text
    content: |
      10 TEXT:HOME
    suffix: .bas
  # Partial code pulled from escape-from-monster-caverns.bas in the bt tests
  keyPerfectSample:
    type: text
    content: |
      1  GOTO 10
      2  HOME : RETURN
      10  REM  ESCAPE FROM MONSTER CAVERNS
      100  PRINT "YOU CAN PLAY THIS GAME IN 3 VERSIONS:"
      110  PRINT
      120  PRINT  TAB( 5);"1-HARD"
      130  PRINT  TAB( 5);"2-MEDIUM"
      140  PRINT  TAB( 5);"3-EASY"
      150  PRINT
      160  PRINT "WHICH ONE DO YOU WANT";
      170  INPUT DI
      180  IF DI <1  THEN 160
      190  IF DI >3  THEN 160
      200  GOSUB 2
      210  PRINT "YOU ARE A FAMOUS EXPLORER WHO HAS"
      220  PRINT "SPENT YEARS PREPARING FOR A GREAT"
      230  PRINT "EXPEDITION TO THE ISLAND OF PIHC,"
      240  PRINT "AN UNCHARTED DOT OF LAND THOUSANDS"
      250  PRINT "OF MILES PRON CIVILIZATION.  YOUR"
      260  PRINT "RESEARCH HAS LED TO A DUSTY OLD"
    suffix: .bas

tests:
  - name: Forms of help
    steps:
      - command: bt --help
        criteria:
          match: contains
        stdout: "Usage: bt"
      - command: bt
        criteria:
          match: contains
        stderr: "Usage: bt"
        rc: 2
  - name: list output
    steps:
      - command: bt --list $helloWorldUC
        criteria:
          whitespace: trim
        stdout: |
          10  TEXT
          20  HOME
          30  PRINT "HELLO, WORLD"
          40  END
  - name: copy/paste output
    steps:
      - command: bt --copy $helloWorldUC
        criteria:
          whitespace: trim
        stdout: |
          0067:01 08 2A 08
          00AF:2A 08
          0800:00
          0801:07 08 0A 00 89 00 0D 08 14 00 97 00 21 08 1E 00
          0811:BA 22 48 45 4C 4C 4F 2C 20 57 4F 52 4C 44 22 00
          0821:27 08 28 00 80 00 00 00
  - name: optimize output
    steps:
      - command: bt --optimize --list $helloWorldUC
        criteria:
          whitespace: trim
        stdout: |
          0  TEXT : HOME : PRINT "HELLO, WORLD": END
  - name: wrap output
    steps:
      - command: bt --wrapper --hex $helloWorldUC
        criteria:
          whitespace: trim
        stdout: |
          0801: 16 08 0a 00 b9 31 30 33 2c 32 34 3a b9 31 30 34  .....103,24:.104
          0811: 2c 38 3a ac 00 00 00 1e 08 0a 00 89 00 24 08 14  ,8:..........$..
          0821: 00 97 00 38 08 1e 00 ba 22 48 45 4c 4c 4f 2c 20  ...8...."HELLO,
          0831: 57 4f 52 4c 44 22 00 3e 08 28 00 80 00 00 00 ..  WORLD".>.(..... 
  - name: check number preservation
    steps:
      # This keeps numbers as-is
      - command: bt --preserve --list $numberPreservation
        criteria:
          whitespace: trim
        stdout: |
          10  PRINT "MATHING"
          30 A = .4
          40 B = 0.6000
          50 C =  - .250
          60 D =  - 0.70
          70  PRINT "A=";A
          80  PRINT "B=";B
          90  PRINT "C=";C
          95  PRINT "D=";D
  - name: check numbers not being preserved
    variables:
      switch: ["--modern", "--classic"]
    steps:
      # These rewrite numbers
      - command: bt $switch --list $numberPreservation
        criteria:
          whitespace: trim
        stdout: |
          10  PRINT "MATHING"
          30 A = 0.4
          40 B = 0.6
          50 C =  - 0.25
          60 D =  - 0.7
          70  PRINT "A=";A
          80  PRINT "B=";B
          90  PRINT "C=";C
          95  PRINT "D=";D
  - name: check number optimization
    steps:
      - command: bt -f=shorten-numbers --list $numberPreservation
        criteria:
          whitespace: trim
        stdout: |
          10  PRINT "MATHING"
          30 A = .4
          40 B = .6
          50 C =  - .25
          60 D =  - .7
          70  PRINT "A=";A
          80  PRINT "B=";B
          90  PRINT "C=";C
          95  PRINT "D=";D

  - name: Nibble Checkit test
    steps:
      - command: bt --checkit $checkitSample
        criteria:
          match: contains
          whitespace: ignore
        stdout: |
          37|10 REM RING THE BELL
          54|20 FOR J = 1 TO 5: PRINT CHR$ (7): NEXT J
          91|30 END
          TOTAL: 1CB9

  - name: Compute! Automatic Proofreader test
    steps:
      - command: bt --proofreader $proofreaderSample
        criteria:
          match: contains
          whitespace: ignore
        stdout: |
          4A|10 HOME
          52|20 D$ = CHR$ (4)
          25|40 PRINT "DO YOU WANT TO:"
          A6|50 PRINT " (1) MAKE A SPEEDSCRIPT FILE INTO A TEXT FILE"
          AE|60 PRINT " (2) MAKE A TEXT FILE INTO A SPEEDSCRIPT FILE"
          67|70 GET A$:A = VAL (A$)
          47|80 IF A < > 1 AND A < > 2 THEN 70
          65|90 ON A GOTO 100,200

  - name: Nibble Apple Checker 3.0 test
    steps:
      - command: bt --apple-checker $appleCheckerSample
        criteria:
          match: contains
          whitespace: ignore
        stdout: |
          Length: 0002
          Checksum: 4B

  - name: MicroSPARC Key Perfect 4.0 test
    steps:
      - command: bt --key-perfect-4 $keyPerfectSample
        criteria:
          whitespace: ignore
        stdout: |
          Line# - Line#   CODE-4.0
          -------------   --------
              1 -   160       4C2A
            170 -   260       6D52
          PROGRAM TOTAL       01A0
  - name: MicroSPARC Key Perfect 4.0 lowercase/uppercase test
    variables:
      source: [ "$helloWorldUC", "$helloWorldLC"]
      result:   # Note: result varies by case
        - |     # UPPERCASE
          Line# - Line#   CODE-4.0
          -------------   --------
          10 -    40       0CE8
          PROGRAM TOTAL         23
        - |     # lowercase
          Line# - Line#   CODE-4.0
          -------------   --------
          10 -    40       0A58
          PROGRAM TOTAL         23
    steps:
      - command: bt --kp4 $source
        criteria:
          whitespace: ignore
        stdout: $result

  - name: MicroSPARC Key Perfect 5.0 test
    steps:
      - command: bt --key-perfect-5 $keyPerfectSample
        criteria:
          whitespace: ignore
        stdout: |
          Line# - Line#   CODE-5.0
          -------------   --------
              1 -   160   E11CFC2E
            170 -   260   CF1C6F7F
          PROGRAM TOTAL   D6462CDD
  - name: MicroSPARC Key Perfect 5.0 lowercase/uppercase test
    variables:
      source: [ "$helloWorldUC", "$helloWorldLC" ]
    steps:
      - command: bt --kp5 $source
        criteria:
          whitespace: ignore
        stdout: |   # Note: result is the same regardless of case
          Line# - Line#   CODE-5.0
          -------------   --------
             10 -    40   64B6C397
          PROGRAM TOTAL   64B6C397
